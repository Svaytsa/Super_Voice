# ADR 0001: Protocol and Layout Baseline

## Контекст
Система мультимедийной пересылки использует локальные модели LocalAI и требует согласованного обмена данными между клиентами, сервером и вспомогательными службами. Необходимо определить заголовок патча, структуру системных сообщений, зарезервированные порты и базовые директории сервера для хранения артефактов MCP.

## Решение
- **Заголовок патча:** `X-Multimedia-Patch` — обязательный HTTP-заголовок, который описывает версию патча протокола, хэш артефакта MCP и контрольную сумму полезной нагрузки. Формат: `X-Multimedia-Patch: <semver>; artifact=<sha256>; checksum=<md5>`.
- **Системные сообщения:**
  - `system.heartbeat` — отправляется сервером раз в 10 секунд с отметкой времени и состоянием очередей.
  - `system.patch-applied` — подтверждает установку нового MCP-артефакта, содержит идентификатор патча, версию протокола и список поддерживаемых клиентов.
  - `system.media-sync` — инициирует синхронизацию мультимедийных потоков и сообщает о смещении тайм-кодов.
- **Порты:**
  - `8080/tcp` — основной REST/gRPC шлюз протокола.
  - `8081/tcp` — потоковое мультимедийное соединение (WebRTC-SFU).
  - `9090/tcp` — порт наблюдаемости (Prometheus/OTLP).
- **Директории сервера:**
  - `/srv/localai/models` — хранение локальных моделей и их версий.
  - `/srv/localai/artifacts/mcp` — репозиторий MCP-артефактов и манифестов.
  - `/var/log/multimedia-forwarding` — журналы событий сервера.
  - `/var/run/multimedia-forwarding` — сокеты и временные файлы активных сессий.

## Последствия
Принятые соглашения позволяют согласовать клиентскую и серверную реализацию, автоматизировать проверку версий патчей и упростить маршрутизацию трафика через заранее выделенные порты. Директории упрощают бэкап артефактов и их аудит.
